<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="container">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" style="display: none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

        <!-- Header -->
        <header class="header">
            <div>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö</div>
            <div>
                <span id="userStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                <button id="logoutButton">‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <div id="userContent">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ô‡∏µ‡πâ -->
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div>
                <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
                <ul id="onlineUsers"></ul>
            </div>
        </aside>

        <div class="media">
            <button id="muteMicButton">üé§ ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
            <div id="micLevel" style="width: 200px; height: 10px; background: #ccc; margin-top: 5px;">
                <div style="height: 100%; width: 0%; background: green;" id="micLevelBar"></div>
            </div>
            <button id="muteSoundButton">üîä ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <div id="soundLevel" style="width: 200px; height: 10px; background: #ccc; margin-top: 5px;">
                <div style="height: 100%; width: 0%; background: blue;" id="soundLevelBar"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <input type="text" id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á">
            <button id="sendButton">‡∏™‡πà‡∏á</button>
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getDatabase, ref, get, set, push, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhY2moqT78c63vjGCDYr4LcQwia35_V_A",
            authDomain: "chatgray-56ce4.firebaseapp.com",
            projectId: "chatgray-56ce4",
            storageBucket: "chatgray-56ce4.firebasestorage.app",
            messagingSenderId: "931095586310",
            appId: "1:931095586310:web:8302d33d1cbdb282e24587",
            measurementId: "G-VSC2J7J756"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM Elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const userStatus = document.getElementById('userStatus');
        const logoutButton = document.getElementById('logoutButton');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const userContent = document.getElementById('userContent');
        const onlineUsersList = document.getElementById('onlineUsers');

        // Functions
        const username = localStorage.getItem('username');
        const password = localStorage.getItem('password');

        function redirectToLogin() {
            Swal.fire({
                icon: 'warning',
                title: 'Invalid login!',
                text: 'You will be redirected to the login page.',
                showConfirmButton: false,
                timer: 2000
            }).then(() => {
                window.location.href = '/login.html';
            });
        }

        function updateContentHeight() {
            const messages = userContent.querySelectorAll('.message');
            if (messages.length >= 6) {
                userContent.style.maxHeight = '315px';
            } else {
                userContent.style.maxHeight = 'none';
            }
        }

        function scrollToLatestMessage() {
            userContent.scrollTop = userContent.scrollHeight;
        }

        // Check login status
        if (!username || !password) {
            redirectToLogin();
        } else {
            const userRef = ref(database, 'users/' + username);
            loadingSpinner.style.display = 'block';
            get(userRef)
                .then(snapshot => {
                    loadingSpinner.style.display = 'none';
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.password === password) {
                            userStatus.textContent = `${username} (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)`;

                            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô Firebase
                            const userStatusRef = ref(database, `onlineUsers/${username}`);
                            set(userStatusRef, { username: username, status: "online" });
                            onDisconnect(userStatusRef).set({ username: username, status: "offline" });

                        } else {
                            redirectToLogin();
                        }
                    } else {
                        redirectToLogin();
                    }
                })
                .catch(error => {
                    console.error('Firebase error:', error);
                    loadingSpinner.style.display = 'none';
                    redirectToLogin();
                });
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        const lastLoadTime = new Date().toISOString();
        sessionStorage.setItem('lastLoadTime', lastLoadTime);

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        const onlineUsersRef = ref(database, 'onlineUsers');
        onValue(onlineUsersRef, (snapshot) => {
            onlineUsersList.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    if (userData.status === "online") { // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                        const userItem = document.createElement('li');
                        userItem.textContent = userData.username;
                        onlineUsersList.appendChild(userItem);
                    }
                });
            } else {
                const noUsersItem = document.createElement('li');
                noUsersItem.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                onlineUsersList.appendChild(noUsersItem);
            }
        });

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        sendButton.addEventListener('click', function () {
            const text = userInput.value.trim();
            if (text !== '') {
                const now = new Date();
                const messageData = {
                    text: text,
                    timestamp: now.toISOString(),
                    username: username
                };

                const messagesRef = ref(database, 'messages'); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô 'messages'
                push(messagesRef, messageData)
                    .then(() => {
                        userInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ'
                        });
                    });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°!',
                    text: '‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ'
                });
            }
        });

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        const messagesRef = ref(database, 'messages'); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å 'messages'
        onValue(messagesRef, (snapshot) => {
            userContent.innerHTML = '';
            const lastLoadTime = sessionStorage.getItem('lastLoadTime'); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage
            snapshot.forEach(childSnapshot => {
                const messageData = childSnapshot.val();

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ timestamp ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                if (new Date(messageData.timestamp) >= new Date(lastLoadTime)) {
                    const message = document.createElement('div');
                    message.classList.add('message');

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
                    const messageText = `
                    <strong><a href="#" class="username-link">${messageData.username}</a>:</strong> 
                    <span>${messageData.text}</span>
                    <span class="timestamp">‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(messageData.timestamp).toLocaleDateString()} ${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                `;
                    message.innerHTML = messageText;
                    userContent.appendChild(message);
                }
            });
            updateContentHeight();
            scrollToLatestMessage();
        });

        // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
        userContent.addEventListener('click', function (e) {
            if (e.target && e.target.classList.contains('username-link')) {
                const clickedUsername = e.target.textContent; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                userInput.value = `@${clickedUsername} `; // ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
            }
        });

        // Handle Enter key press
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        // Logout function
        logoutButton.addEventListener('click', () => {
            Swal.fire({
                icon: 'question',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå?',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(result => {
                if (result.isConfirmed) {
                    const userStatusRef = ref(database, `onlineUsers/${username}`);
                    remove(userStatusRef)
                        .then(() => {
                            localStorage.removeItem('username');
                            localStorage.removeItem('password');
                            window.location.href = '/login.html';
                        })
                        .catch(error => {
                            console.error('Logout error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡πÑ‡∏î‡πâ'
                            });
                        });
                }
            });
        });

        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        window.addEventListener('beforeunload', () => {
            const userMessagesRef = ref(database, `messages/${username}`);
            remove(userMessagesRef)
                .then(() => {
                    console.log('User-specific chat messages cleared.');
                })
                .catch(error => {
                    console.error('Error clearing user-specific messages:', error);
                });
        });

        const muteMicButton = document.getElementById('muteMicButton');
        const muteSoundButton = document.getElementById('muteSoundButton');
        const micLevelBar = document.getElementById('micLevelBar');
        const soundLevelBar = document.getElementById('soundLevelBar');

        let isMicMuted = false;
        let isSoundMuted = false;
        let localStream;
        let peerConnection;
        let audioContext, micAnalyser, soundAnalyser;
        let micDataArray, soundDataArray;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Signaling Server (‡πÉ‡∏ä‡πâ wss:// ‡πÅ‡∏ó‡∏ô ws:// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render)
        const signalingServer = new WebSocket('https://chat-44gj.onrender.com/'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        signalingServer.onmessage = async event => {
            const data = JSON.parse(event.data);

            if (data.type === 'offer') {
                await handleOffer(data.offer);
            } else if (data.type === 'answer') {
                await handleAnswer(data.answer);
            } else if (data.type === 'candidate') {
                await handleCandidate(data.candidate);
            }
        };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        async function initAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                if (localStream.getAudioTracks().length === 0) {
                    console.error('‡πÑ‡∏°‡πà‡∏°‡∏µ track ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô stream');
                    return;
                }

                audioContext = new AudioContext();
                const micSource = audioContext.createMediaStreamSource(localStream);

                micAnalyser = audioContext.createAnalyser();
                micAnalyser.fftSize = 256;
                micSource.connect(micAnalyser);
                micDataArray = new Uint8Array(micAnalyser.frequencyBinCount);

                console.log('‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                setupWebRTC();
                startVisualizing();
            } catch (err) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô:', err);
            }
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WebRTC
        function setupWebRTC() {
            const configuration = {
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° localStream ‡∏•‡∏á‡πÉ‡∏ô Peer Connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Stream ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô
            peerConnection.ontrack = event => {
                const remoteAudio = document.createElement('audio');
                remoteAudio.srcObject = event.streams[0];
                remoteAudio.autoplay = true;
                document.body.appendChild(remoteAudio);
            };

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ ICE Candidate ‡πÉ‡∏´‡∏°‡πà
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                }
            };
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer
        async function createOffer() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            signalingServer.send(JSON.stringify({ type: 'offer', offer }));
        }

        // ‡∏£‡∏±‡∏ö Offer
        async function handleOffer(offer) {
            peerConnection = new RTCPeerConnection(iceServers);
            peerConnection.ontrack = (event) => {
                const remoteStream = new MediaStream(event.streams[0]);
                const audioElement = new Audio();
                audioElement.srcObject = remoteStream;
                audioElement.play();
            };
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            signalingServer.send(JSON.stringify({ type: 'answer', answer }));
        }


        // ‡∏£‡∏±‡∏ö Answer
        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // ‡∏£‡∏±‡∏ö ICE Candidate
        async function handleCandidate(candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡∏Ñ‡πå
        function startVisualizing() {
            function visualize() {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡∏Ñ‡πå
                if (micAnalyser) {
                    micAnalyser.getByteFrequencyData(micDataArray);
                    const micVolume = micDataArray.reduce((a, b) => a + b) / micDataArray.length;
                    micLevelBar.style.width = `${micVolume}%`;
                }

                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                if (soundAnalyser) {
                    soundAnalyser.getByteFrequencyData(soundDataArray);
                    const soundVolume = soundDataArray.reduce((a, b) => a + b) / soundDataArray.length;
                    soundLevelBar.style.width = `${soundVolume}%`;
                }

                requestAnimationFrame(visualize);
            }

            visualize();
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå
        muteMicButton.addEventListener('click', () => {
            if (localStream) {
                isMicMuted = !isMicMuted;
                localStream.getAudioTracks().forEach(track => (track.enabled = !isMicMuted));
                muteMicButton.textContent = isMicMuted ? 'üé§ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå' : 'üé§ ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå';
                console.log(isMicMuted ? '‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î' : '‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î');
            }
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        muteSoundButton.addEventListener('click', () => {
            isSoundMuted = !isSoundMuted;
            muteSoundButton.textContent = isSoundMuted ? 'üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á' : 'üîä ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            console.log(isSoundMuted ? '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î' : '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î');
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        initAudio();

    </script>

</body>

</html>